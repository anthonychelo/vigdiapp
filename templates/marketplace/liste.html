{% extends 'base.html' %}
{% block title %}March√© ‚Äì ViGDiM{% endblock %}
{% block content %}
<div class="container py-4">

  <!-- Filtres -->
  <form method="get" class="mb-4">
    <div class="row g-2 align-items-end">
      <div class="col-md-4">
        <input type="text" name="q" value="{{ q }}" class="form-control rounded-3"
               placeholder="üîç Titre, description, ville...">
      </div>
      <div class="col-md-3">
        <select name="categorie" class="form-select rounded-3">
          <option value="">Toutes cat√©gories</option>
          {% for val, label in categories %}
            <option value="{{ val }}" {% if categorie_active == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <select name="type" class="form-select rounded-3">
          <option value="">Tous types</option>
          {% for val, label in types %}
            <option value="{{ val }}" {% if type_actif == val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <button type="submit" class="btn btn-primary w-100 rounded-3"
                style="background:var(--indigo);border-color:var(--indigo);">
          Filtrer
        </button>
      </div>
      {% if q or categorie_active or type_actif %}
        <div class="col-md-1">
          <a href="{% url 'marketplace:liste' %}" class="btn btn-outline-secondary w-100 rounded-3">‚úï</a>
        </div>
      {% endif %}
    </div>
  </form>

  <!-- R√©sultats -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <span class="text-muted small">{{ articles.paginator.count }} article(s) trouv√©(s)</span>
    {% if user.is_authenticated %}
      <a href="{% url 'marketplace:ajouter' %}" class="btn btn-warning btn-sm fw-bold rounded-pill">
        <i class="bi bi-plus-lg me-1"></i>Publier un article
      </a>
    {% endif %}
  </div>

  {% if articles %}
    <div class="row g-3">
      {% for article in articles %}
        <div class="col-6 col-md-4 col-lg-3">
          <a href="{% url 'marketplace:detail' article.pk %}" class="text-decoration-none">
            <div class="card-article card h-100">
              <!-- Photo -->
              {% with photo=article.photo_principale %}
                {% if photo %}
                  <img src="{{ photo.url }}" alt="{{ article.titre }}">
                {% else %}
                  <div class="d-flex align-items-center justify-content-center bg-light" style="height:190px;font-size:3rem;">üì¶</div>
                {% endif %}
              {% endwith %}

              <div class="card-body p-3">
                <!-- Tag type -->
                <span class="badge badge-certifie tag-{{ article.type_transaction }} mb-1" style="font-size:.7rem;">
                  {% if article.type_transaction == 'echanger' %}üîÑ √âchange
                  {% elif article.type_transaction == 'don' %}üéÅ Don
                  {% else %}üí∞ Vente{% endif %}
                </span>

                <p class="fw-bold mb-1 text-dark" style="font-size:.9rem;line-height:1.3;">
                  {{ article.titre|truncatechars:45 }}
                </p>

                <p class="fw-bold mb-2" style="color:var(--indigo);">
                  {% if article.type_transaction == 'don' %}
                    <span class="text-success">Gratuit</span>
                  {% else %}
                    {{ article.prix|floatformat:"0" }} FCFA
                  {% endif %}
                </p>

                <!-- Vendeur avec badge style Instagram -->
                <div class="d-flex align-items-center gap-2 small text-muted">
                  {% with u=article.vendeur taille=24 font=".6rem" badge_sz=10 %}
                    {% include 'partials/avatar.html' %}
                  {% endwith %}
                  <span class="text-truncate">{{ article.vendeur.get_full_name|default:article.vendeur.username }}</span>
                  {% include 'partials/badge_inline.html' with u=article.vendeur %}
                </div>

                <div class="text-muted" style="font-size:.75rem;">
                  <i class="bi bi-geo-alt"></i> {{ article.ville|default:"Cameroun" }}
                </div>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if articles.has_other_pages %}
      <nav class="mt-4">
        <ul class="pagination justify-content-center">
          {% if articles.has_previous %}
            <li class="page-item">
              <a class="page-link rounded-3 me-1" href="?page={{ articles.previous_page_number }}&q={{ q }}&categorie={{ categorie_active }}&type={{ type_actif }}">‚Äπ</a>
            </li>
          {% endif %}
          <li class="page-item active">
            <span class="page-link rounded-3" style="background:var(--indigo);border-color:var(--indigo);">
              {{ articles.number }} / {{ articles.paginator.num_pages }}
            </span>
          </li>
          {% if articles.has_next %}
            <li class="page-item">
              <a class="page-link rounded-3 ms-1" href="?page={{ articles.next_page_number }}&q={{ q }}&categorie={{ categorie_active }}&type={{ type_actif }}">‚Ä∫</a>
            </li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}

  {% else %}
    <div class="text-center py-5 text-muted">
      <i class="bi bi-bag-x fs-1 d-block mb-3" style="color:var(--indigo);opacity:.3;"></i>
      <h5>Aucun article trouv√©</h5>
      <p>Essayez d'autres mots-cl√©s ou
        <a href="{% url 'marketplace:demande_article' %}">demandez √† l'admin</a>
      </p>
    </div>
  {% endif %}

</div>
{% endblock %}
