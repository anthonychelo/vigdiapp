<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}ViGDi{% endblock %}</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <style>
    :root {
      --indigo: #4f46e5;
      --indigo-dark: #3730a3;
      --green: #10b981;
    }
    body { background: #f8fafc; font-family: 'Segoe UI', sans-serif; }

    /* ── Navbar ── */
    .navbar { background: var(--indigo) !important; }
    .navbar-brand { font-weight: 800; font-size: 1.3rem; letter-spacing: -0.5px; }
    .nav-link { color: rgba(255,255,255,.85) !important; }
    .nav-link:hover { color: #fff !important; }

    /* ── Badge utilisateur (style Instagram) ── */
    .badge-certifie {
      display: inline-flex; align-items: center; gap: 3px;
      font-size: .75rem; font-weight: 700;
      padding: 2px 8px; border-radius: 999px;
      white-space: nowrap;
    }
    .badge-blue   { background: #dbeafe; color: #1d4ed8; }
    .badge-gold   { background: #fef3c7; color: #92400e; }
    .badge-green  { background: #d1fae5; color: #065f46; }
    .badge-purple { background: #ede9fe; color: #5b21b6; }

    /* Avatar photo de profil */
    .avatar-sm {
      width: 38px; height: 38px; border-radius: 50%;
      object-fit: cover; border: 2px solid rgba(255,255,255,.3);
    }
    .avatar-initiales {
      width: 38px; height: 38px; border-radius: 50%;
      background: rgba(255,255,255,.2); color: white;
      display: inline-flex; align-items: center; justify-content: center;
      font-weight: 700; font-size: .9rem;
    }

    /* ── Cards articles ── */
    .card-article {
      border: none; border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,.07);
      transition: transform .15s, box-shadow .15s;
      overflow: hidden;
    }
    .card-article:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,.12); }
    .card-article img { height: 190px; object-fit: cover; width: 100%; }

    /* ── Tags ── */
    .tag-echanger { background: #d1fae5; color: #065f46; }
    .tag-vendre   { background: #dbeafe; color: #1e40af; }
    .tag-don      { background: #fce7f3; color: #9d174d; }

    /* ── Messages ── */
    .bubble-sent     { background: #dbeafe; border-radius: 18px 18px 4px 18px; }
    .bubble-received { background: #fff; border: 1px solid #e5e7eb; border-radius: 18px 18px 18px 4px; }

    /* ── Footer ── */
    footer { background: var(--indigo-dark); color: rgba(255,255,255,.7); }

    /* ── Notifications non-lus ── */
    .badge-unread {
      position: absolute; top: -4px; right: -6px;
      background: #ef4444; color: white;
      border-radius: 50%; width: 16px; height: 16px;
      font-size: 10px; display: flex; align-items: center; justify-content: center;
    }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>

<!-- ── Navbar ───────────────────────────────────────────── -->
<nav class="navbar navbar-expand-lg navbar-dark sticky-top shadow-sm">
  <div class="container">
    <a class="navbar-brand text-white d-flex align-items-center gap-2" href="{% url 'marketplace:liste' %}">
      <!-- Logo ViGDi marché -->
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="32" height="32">
        <rect width="40" height="40" rx="9" fill="white" opacity="0.2"/>
        <!-- Sol -->
        <rect x="5" y="29" width="30" height="2" rx="1" fill="white" opacity="0.5"/>
        <!-- Étal gauche -->
        <rect x="4" y="20" width="14" height="9" rx="1" fill="white"/>
        <rect x="3" y="17" width="16" height="4" rx="1" fill="white" opacity="0.8"/>
        <rect x="6" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
        <rect x="14" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
        <!-- Étal droit -->
        <rect x="22" y="20" width="14" height="9" rx="1" fill="white"/>
        <rect x="21" y="17" width="16" height="4" rx="1" fill="white" opacity="0.8"/>
        <rect x="24" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
        <rect x="32" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
        <!-- Soleil -->
        <circle cx="20" cy="9" r="4" fill="#fbbf24"/>
        <line x1="20" y1="3" x2="20" y2="2" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="20" y1="15" x2="20" y2="16" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="14" y1="9" x2="13" y2="9" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
        <line x1="26" y1="9" x2="27" y2="9" stroke="#fbbf24" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span style="font-weight:800;font-size:1.3rem;letter-spacing:-0.5px;">ViGDi</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#nav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="nav">
      <!-- Recherche rapide -->
      <form class="d-flex mx-auto" style="max-width:340px;" action="{% url 'marketplace:liste' %}" method="get">
        <input class="form-control form-control-sm rounded-pill" type="search"
               name="q" placeholder="Rechercher un article..." value="{{ request.GET.q }}">
      </form>

      <ul class="navbar-nav ms-auto align-items-center gap-1">
        {% if user.is_authenticated %}
          <!-- Messagerie avec badge non-lus -->
          <li class="nav-item position-relative">
            <a class="nav-link" href="{% url 'messaging:liste' %}">
              <i class="bi bi-chat-dots fs-5"></i>
              <span class="badge-unread" id="unread-count" style="display:none;">!</span>
            </a>
          </li>
          <!-- Mes échanges -->
          <li class="nav-item">
            <a class="nav-link" href="{% url 'marketplace:mes_demandes' %}" title="Mes échanges">
              <i class="bi bi-arrow-left-right fs-5"></i>
            </a>
          </li>
          <!-- Publier -->
          <li class="nav-item">
            <a class="btn btn-sm btn-warning fw-bold ms-2" href="{% url 'marketplace:ajouter' %}">
              <i class="bi bi-plus-lg"></i> Publier
            </a>
          </li>
          <!-- Avatar + menu -->
          <li class="nav-item dropdown ms-2">
            <a class="nav-link dropdown-toggle d-flex align-items-center gap-2 p-0"
               href="#" data-bs-toggle="dropdown">
              <!-- Avatar + badge style Instagram dans la navbar -->
              {% with u=user taille=36 font=".9rem" badge_sz=14 %}
                {% include 'partials/avatar.html' %}
              {% endwith %}
              <span class="text-white d-none d-lg-inline d-flex align-items-center gap-1">
                {{ user.first_name|default:user.username }}
                {% include 'partials/badge_inline.html' with u=user %}
              </span>
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow">
              <li><a class="dropdown-item" href="{% url 'accounts:profil' %}">
                <i class="bi bi-person me-2"></i>Mon profil</a></li>
              <li><a class="dropdown-item" href="{% url 'accounts:modifier_profil' %}">
                <i class="bi bi-pencil me-2"></i>Modifier profil</a></li>
              <li><a class="dropdown-item" href="{% url 'accounts:demande_verification' %}">
                <i class="bi bi-patch-check me-2"></i>Demander certification</a></li>
              <li><a class="dropdown-item" href="{% url 'marketplace:demande_article' %}">
                <i class="bi bi-search me-2"></i>Demander un article</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="{% url 'accounts:deconnexion' %}">
                <i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
            </ul>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="nav-link" href="{% url 'accounts:connexion' %}">Connexion</a>
          </li>
          <li class="nav-item">
            <a class="btn btn-sm btn-light fw-bold" href="{% url 'accounts:inscription' %}">S'inscrire</a>
          </li>
        {% endif %}
      </ul>
    </div>
  </div>
</nav>

<!-- ── Messages flash ─────────────────────────────────── -->
{% if messages %}
<div class="container mt-3">
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- ── Contenu principal ──────────────────────────────── -->
<main>
  {% block content %}{% endblock %}
</main>

<!-- ── Footer ────────────────────────────────────────── -->
<footer class="py-4 mt-5">
  <div class="container text-center">
    <p class="mb-1 fw-bold text-white">ViGDi</p>
    <p class="small mb-0">votre vide grenier dynamique...</p>
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% block extra_js %}{% endblock %}
</body>
</html>