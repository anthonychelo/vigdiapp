<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}ViGDi{% endblock %}</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- PWA -->
  {% load static %}
  <link rel="manifest" href="{% static 'pwa/manifest.json' %}">
  <meta name="theme-color" content="#5B4FE9">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="ViGDi">
  <link rel="apple-touch-icon" href="{% static 'pwa/icon-192.png' %}">
  <link rel="icon" type="image/png" sizes="192x192" href="{% static 'pwa/icon-192.png' %}">
  <style>
    :root {
      --primary: #5B4FE9;
      --primary-dark: #4338ca;
      --primary-light: #EEF2FF;
      --accent: #F59E0B;
      --bg: #F4F5FB;
      --text: #1a1a2e;
      --muted: #6b7280;
      --border: #e5e7eb;
      --bottom-h: 70px;
    }
    * { box-sizing: border-box; }
    body {
      background: var(--bg);
      font-family: 'Plus Jakarta Sans', sans-serif;
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      padding-bottom: var(--bottom-h);
    }
    /* ── Top navbar ── */
    .top-nav {
      background: var(--primary);
      height: 64px;
      display: flex;
      align-items: center;
      padding: 0 1rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 20px rgba(91,79,233,.3);
      gap: .75rem;
    }
    .brand { display:flex;align-items:center;gap:8px;color:white;text-decoration:none;font-weight:800;font-size:1.3rem;flex-shrink:0; }
    .search-wrapper { position:relative;flex:1;max-width:380px; }
    .search-wrapper i { position:absolute;left:.75rem;top:50%;transform:translateY(-50%);color:rgba(255,255,255,.6);font-size:.85rem; }
    .search-wrapper input { background:rgba(255,255,255,.15);border:none;border-radius:50px;color:white;padding:.42rem 1rem .42rem 2.4rem;font-size:.88rem;width:100%; }
    .search-wrapper input::placeholder { color:rgba(255,255,255,.55); }
    .search-wrapper input:focus { outline:none;background:rgba(255,255,255,.25); }
    .nav-actions { display:flex;align-items:center;gap:.4rem;margin-left:auto;flex-shrink:0; }
    .nav-icon-btn { width:38px;height:38px;border-radius:50%;background:rgba(255,255,255,.15);color:white;display:flex;align-items:center;justify-content:center;text-decoration:none;font-size:1.1rem;position:relative;transition:background .2s; }
    .nav-icon-btn:hover { background:rgba(255,255,255,.25);color:white; }
    .publish-btn { background:var(--accent);color:white;border:none;border-radius:50px;padding:.38rem 1rem;font-weight:700;font-size:.83rem;text-decoration:none;display:flex;align-items:center;gap:4px;transition:all .15s; }
    .publish-btn:hover { color:white;transform:translateY(-1px);box-shadow:0 4px 12px rgba(245,158,11,.4); }
    .avatar-nav { width:36px;height:36px;border-radius:50%;object-fit:cover;border:2px solid rgba(255,255,255,.4); }
    .avatar-nav-initials { width:36px;height:36px;border-radius:50%;background:rgba(255,255,255,.2);color:white;font-weight:700;font-size:.85rem;display:flex;align-items:center;justify-content:center;border:2px solid rgba(255,255,255,.4); }
    /* ── Bottom nav ── */
    .bottom-nav { position:fixed;bottom:0;left:0;right:0;height:var(--bottom-h);background:white;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-around;z-index:100;box-shadow:0 -4px 20px rgba(0,0,0,.08); }
    .bnav-item { display:flex;flex-direction:column;align-items:center;gap:2px;text-decoration:none;color:var(--muted);font-size:.62rem;font-weight:600;padding:.4rem .6rem;border-radius:12px;transition:all .2s;position:relative; }
    .bnav-item i { font-size:1.25rem;transition:transform .2s; }
    .bnav-item.active { color:var(--primary); }
    .bnav-item.active i { transform:translateY(-2px); }
    .bnav-item:hover { color:var(--primary); }
    .fab-btn { width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:white;display:flex;align-items:center;justify-content:center;font-size:1.4rem;text-decoration:none;box-shadow:0 4px 18px rgba(91,79,233,.5);transition:all .2s;margin-top:-18px; }
    .fab-btn:hover { color:white;transform:scale(1.08);box-shadow:0 8px 24px rgba(91,79,233,.6); }
    .badge-dot { position:absolute;top:4px;right:6px;width:8px;height:8px;background:#ef4444;border-radius:50%;border:2px solid white; }
    /* ── Cards ── */
    .card-article { border:none;border-radius:16px;box-shadow:0 2px 12px rgba(0,0,0,.06);transition:transform .2s,box-shadow .2s;overflow:hidden;background:white; }
    .card-article:hover { transform:translateY(-4px);box-shadow:0 8px 25px rgba(0,0,0,.12); }
    .card-article img { height:180px;object-fit:cover;width:100%; }
    /* ── Tags ── */
    .badge-certifie { display:inline-flex;align-items:center;gap:3px;font-size:.7rem;font-weight:700;padding:2px 8px;border-radius:999px;white-space:nowrap; }
    .tag-echanger { background:#d1fae5;color:#065f46; }
    .tag-vendre   { background:#dbeafe;color:#1e40af; }
    .tag-don      { background:#fce7f3;color:#9d174d; }
    /* ── Messages ── */
    .bubble-sent     { background:#dbeafe;border-radius:18px 18px 4px 18px; }
    .bubble-received { background:#fff;border:1px solid #e5e7eb;border-radius:18px 18px 18px 4px; }
    /* ── Divers ── */
    main { flex:1; }
    .vigdi-card { background:white;border-radius:20px;border:none;box-shadow:0 2px 12px rgba(0,0,0,.06);padding:1.5rem; }
    .btn-vigdi { background:var(--primary);color:white;border:none;border-radius:12px;padding:.7rem 1.5rem;font-weight:700;transition:all .2s; }
    .btn-vigdi:hover { background:var(--primary-dark);color:white;transform:translateY(-1px); }
    .dropdown-menu { border:none;box-shadow:0 8px 30px rgba(0,0,0,.12);border-radius:16px; }
    .dropdown-item { border-radius:8px;padding:.6rem 1rem;font-weight:500; }
    .dropdown-item:hover { background:var(--primary-light);color:var(--primary); }
    /* ── Notification badge ── */
    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 10px;
      padding: 2px 6px;
      min-width: 18px;
      height: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,.2);
    }
    @media (min-width:768px) { body { padding-bottom:0; } .bottom-nav { display:none; } }
  </style>
  {% block extra_css %}{% endblock %}
</head>
<body>

<!-- Top Navbar -->
<nav class="top-nav">
  <a class="brand" href="{% url 'marketplace:liste' %}">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 40 40" width="30" height="30">
      <rect width="40" height="40" rx="9" fill="white" opacity="0.2"/>
      <rect x="5" y="29" width="30" height="2" rx="1" fill="white" opacity="0.5"/>
      <rect x="4" y="20" width="14" height="9" rx="1" fill="white"/>
      <rect x="3" y="17" width="16" height="4" rx="1" fill="white" opacity="0.8"/>
      <rect x="6" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
      <rect x="14" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
      <rect x="22" y="20" width="14" height="9" rx="1" fill="white"/>
      <rect x="21" y="17" width="16" height="4" rx="1" fill="white" opacity="0.8"/>
      <rect x="24" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
      <rect x="32" y="31" width="2" height="4" rx="1" fill="white" opacity="0.6"/>
      <circle cx="20" cy="9" r="4" fill="#fbbf24"/>
    </svg>
    <span>ViGDi</span>
  </a>

  <form action="{% url 'marketplace:liste' %}" method="get" class="search-wrapper">
    <i class="bi bi-search"></i>
    <input type="search" name="q" placeholder="Rechercher un article..." value="{{ request.GET.q }}">
  </form>

  <div class="nav-actions">
    {% if user.is_authenticated %}
      <a href="{% url 'marketplace:ajouter' %}" class="publish-btn d-none d-md-flex">
        <i class="bi bi-plus-lg"></i> Publier
      </a>
      <a href="{% url 'messaging:liste' %}" class="nav-icon-btn">
        <i class="bi bi-chat-dots"></i>
        {% if unread_messages_count > 0 %}
          <span class="notification-badge">{{ unread_messages_count }}</span>
        {% endif %}
      </a>
      <div class="dropdown">
        <a href="#" class="nav-icon-btn p-0" data-bs-toggle="dropdown">
          {% if user.photo_profil %}
            <img src="{{ user.photo_profil.url }}" class="avatar-nav" alt="">
          {% else %}
            <div class="avatar-nav-initials">{{ user.first_name|first|upper|default:user.username|first|upper }}</div>
          {% endif %}
        </a>
        <ul class="dropdown-menu dropdown-menu-end mt-2">
          <li class="px-3 py-2 border-bottom">
            <div class="fw-bold d-flex align-items-center gap-1">
              {{ user.get_full_name|default:user.username }}
              {% include 'partials/badge_inline.html' with u=user %}
            </div>
            <small class="text-muted">{{ user.email }}</small>
          </li>
          <li><a class="dropdown-item" href="{% url 'accounts:profil' %}"><i class="bi bi-person me-2 text-primary"></i>Mon profil</a></li>
          <li><a class="dropdown-item" href="{% url 'accounts:modifier_profil' %}"><i class="bi bi-pencil me-2 text-primary"></i>Modifier profil</a></li>
          <li><a class="dropdown-item" href="{% url 'accounts:demande_verification' %}"><i class="bi bi-patch-check me-2 text-primary"></i>Certification</a></li>
          <li><a class="dropdown-item" href="{% url 'marketplace:mes_demandes' %}"><i class="bi bi-arrow-left-right me-2 text-primary"></i>Mes échanges</a></li>
          {% if user.is_staff %}<li><a class="dropdown-item" href="/admin/"><i class="bi bi-shield me-2 text-danger"></i>Administration</a></li>{% endif %}
          <li><hr class="dropdown-divider"></li>
          <li><a class="dropdown-item text-danger" href="{% url 'accounts:deconnexion' %}"><i class="bi bi-box-arrow-right me-2"></i>Déconnexion</a></li>
        </ul>
      </div>
    {% else %}
      <a href="{% url 'accounts:connexion' %}" class="nav-icon-btn" style="width:auto;padding:0 .75rem;border-radius:50px;font-size:.82rem;font-weight:600;">Connexion</a>
      <a href="{% url 'accounts:inscription' %}" class="publish-btn">S'inscrire</a>
    {% endif %}
  </div>
</nav>

<!-- Flash messages -->
{% if messages %}
<div style="position:fixed;top:72px;left:50%;transform:translateX(-50%);z-index:200;width:90%;max-width:400px;">
  {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm rounded-3 mb-2">
      {{ message }}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- Contenu -->
<main>{% block content %}{% endblock %}</main>

<!-- Bottom Nav (mobile) -->
<nav class="bottom-nav d-md-none">
  <a href="{% url 'marketplace:liste' %}" class="bnav-item {% block nav_marche %}{% endblock %}">
    <i class="bi bi-shop"></i><span>Marché</span>
  </a>
  <a href="{% url 'messaging:liste' %}" class="bnav-item {% block nav_messages %}{% endblock %}">
    <i class="bi bi-chat-dots"></i><span>Messages</span>
    {% if unread_messages_count > 0 %}
      <span class="notification-badge">{{ unread_messages_count }}</span>
    {% endif %}
  </a>
  <a href="{% url 'marketplace:ajouter' %}" class="fab-btn">
    <i class="bi bi-plus-lg"></i>
  </a>
  <a href="{% url 'marketplace:mes_demandes' %}" class="bnav-item {% block nav_echanges %}{% endblock %}">
    <i class="bi bi-arrow-left-right"></i><span>Échanges</span>
  </a>
  {% if user.is_authenticated %}
  <a href="{% url 'accounts:profil' %}" class="bnav-item {% block nav_profil %}{% endblock %}">
    <i class="bi bi-person"></i><span>Profil</span>
  </a>
  {% else %}
  <a href="{% url 'accounts:connexion' %}" class="bnav-item">
    <i class="bi bi-person"></i><span>Connexion</span>
  </a>
  {% endif %}
</nav>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
{% block extra_js %}{% endblock %}

<!-- PWA Service Worker -->
{% load static %}
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('{% static "pwa/service-worker.js" %}')
      .then(r => console.log('SW OK'))
      .catch(e => console.log('SW erreur:', e));
  });
}
let deferredPrompt;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  setTimeout(() => {
    const b = document.getElementById('install-banner');
    if (b) b.style.display = 'flex';
  }, 3000);
});
function installApp() {
  if (deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then(() => {
      deferredPrompt = null;
      document.getElementById('install-banner').style.display = 'none';
    });
  }
}
</script>

<div id="install-banner" style="display:none;position:fixed;bottom:80px;left:1rem;right:1rem;
  background:white;border-radius:16px;padding:1rem;box-shadow:0 8px 30px rgba(0,0,0,.15);
  align-items:center;gap:.75rem;z-index:999;">
  <img src="{% static 'pwa/icon-72.png' %}" width="44" height="44" style="border-radius:10px;">
  <div style="flex:1;">
    <div style="font-weight:700;font-size:.9rem;">Installer ViGDi</div>
    <div style="font-size:.75rem;color:#6b7280;">Accès rapide depuis votre écran d'accueil</div>
  </div>
  <button onclick="installApp()" style="background:#5B4FE9;color:white;border:none;border-radius:10px;padding:.4rem .9rem;font-weight:700;font-size:.82rem;">Installer</button>
  <button onclick="document.getElementById('install-banner').style.display='none'" style="background:none;border:none;color:#9ca3af;font-size:1.2rem;">×</button>
</div>
</body>
</html>