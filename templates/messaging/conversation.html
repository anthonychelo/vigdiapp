{% extends 'base.html' %}
{% block title %}{{ autre.get_full_name|default:autre.username }} – Chat{% endblock %}
{% block content %}
<div class="container py-3" style="max-width:680px;">

  <!-- En-tête conversation -->
  <div class="card border-0 shadow-sm rounded-4 p-3 mb-3">
    <div class="d-flex align-items-center gap-3">
      <a href="{% url 'messaging:liste' %}" class="btn btn-sm btn-light rounded-circle">
        <i class="bi bi-arrow-left"></i>
      </a>

      {% with u=autre taille=46 font="1.1rem" %}
        {% include 'partials/avatar.html' %}
      {% endwith %}

      <div>
        <div class="d-flex align-items-center gap-1">
          <a href="{% url 'accounts:profil_utilisateur' autre.pk %}"
             class="fw-bold text-decoration-none text-dark">
            {{ autre.get_full_name|default:autre.username }}
          </a>
          {% include 'partials/badge_inline.html' with u=autre %}
        </div>
        {% if conv.article %}
          <small class="text-muted">
            <i class="bi bi-tag me-1"></i>
            <a href="{% url 'marketplace:detail' conv.article.pk %}" class="text-primary text-decoration-none">
              {{ conv.article.titre|truncatechars:40 }}
            </a>
          </small>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Messages -->
  <div id="messages-container"
       style="height:calc(100vh - 320px);overflow-y:auto;padding:8px 0;">
    {% for msg in msgs %}
      <div class="d-flex mb-3 {% if msg.expediteur == user %}justify-content-end{% else %}justify-content-start{% endif %}">

        {% if msg.expediteur != user %}
          {% if msg.expediteur.photo_profil %}
            <img src="{{ msg.expediteur.photo_profil.url }}"
                 style="width:32px;height:32px;border-radius:50%;object-fit:cover;margin-right:8px;flex-shrink:0;align-self:flex-end;">
          {% else %}
            <div style="width:32px;height:32px;border-radius:50%;background:var(--indigo);
                        color:white;font-size:.8rem;font-weight:700;display:flex;
                        align-items:center;justify-content:center;margin-right:8px;flex-shrink:0;align-self:flex-end;">
              {{ msg.expediteur.first_name|first|upper|default:msg.expediteur.username|first|upper }}
            </div>
          {% endif %}
        {% endif %}

        <div>
          <div class="p-3 {% if msg.expediteur == user %}bubble-sent{% else %}bubble-received{% endif %}"
               style="max-width:320px;">
            <p class="mb-1" style="font-size:.95rem;
              {% if msg.expediteur == user %}color:#1e40af;{% else %}color:#374151;{% endif %}">
              {{ msg.contenu }}
            </p>
            <small style="{% if msg.expediteur == user %}color:#3b82f6;{% else %}color:#9ca3af;{% endif %}font-size:.7rem;">
              {{ msg.created_at|time:"H:i" }}
              {% if msg.expediteur == user and msg.is_read %}
                <i class="bi bi-check2-all ms-1"></i>
              {% endif %}
            </small>
          </div>
        </div>

      </div>
    {% empty %}
      <div class="text-center py-4 text-muted">
        <i class="bi bi-chat d-block fs-2 mb-2 opacity-25"></i>
        Début de la conversation. Dites bonjour !
      </div>
    {% endfor %}
  </div>

  <!-- Zone de saisie -->
  <div class="card border-0 shadow-sm rounded-4 mt-3">
    <form method="post" class="d-flex align-items-end gap-2 p-3">
      {% csrf_token %}
      <textarea name="contenu" id="msg-input" rows="1"
                class="form-control rounded-4 border-0 bg-light"
                style="resize:none;max-height:120px;overflow-y:auto;"
                placeholder="Écrire un message..."
                onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();this.form.submit();}"></textarea>
      <button type="submit"
              style="background:var(--indigo);border:none;width:44px;height:44px;
                     border-radius:50%;color:white;flex-shrink:0;">
        <i class="bi bi-send-fill"></i>
      </button>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const container = document.getElementById('messages-container');
container.scrollTop = container.scrollHeight;

const input = document.getElementById('msg-input');
input.addEventListener('input', () => {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 120) + 'px';
});
input.focus();
</script>
{% endblock %}